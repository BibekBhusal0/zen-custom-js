import fs from "fs";
import path from "path";

const getSubdirectories = (dir) => {
  return fs.readdirSync(dir).filter((file) => {
    const fullPath = path.join(dir, file);
    return (
      fs.statSync(fullPath).isDirectory() &&
      !file.startsWith(".") &&
      file !== "node_modules" &&
      file !== "dist"
    );
  });
};

const createBanner = (themePath) => {
  const theme = JSON.parse(fs.readFileSync(themePath, "utf-8"));

  let banner = `// ==UserScript==
// @name            ${theme.name}
// @description     ${theme.description}
// @author          ${theme.author}
// @version         ${theme.version}
// @lastUpdated     ${theme.updatedAt}
`;

  if (theme.ignoreCache !== false) {
    banner += `// @ignorecache\n`;
  }

  const standardKeys = [
    "id",
    "name",
    "description",
    "author",
    "version",
    "updatedAt",
    "tags",
    "fork",
    "preferences",
    "style",
    "scripts",
    "readme",
    "image",
    "createdAt",
    "ignoreCache",
  ];

  for (const key in theme) {
    if (!standardKeys.includes(key)) {
      const value = theme[key];
      if (Array.isArray(value)) {
        value.forEach((item) => {
          banner += `// @${key.padEnd(15)} ${item}\n`;
        });
      } else if (typeof value === "boolean") {
        if (value) banner += `// @${key}\n`;
      } else {
        banner += `// @${key.padEnd(15)} ${value}\n`;
      }
    }
  }

  banner += `// ==/UserScript==

// This file was automatically generated. Do not edit this file directly.
// Any changes made here will be overwritten.
// To make changes, please edit the source files in the repository:
// https://github.com/BibekBhusal0/zen-custom-js

`;

  return banner;
};

// Build function
async function buildMod(dir, themePath, entryFile, theme) {
  const banner = createBanner(themePath);
  console.log(`Building ${dir} (${theme.id})...`);

  try {
    const result = await Bun.build({
      entrypoints: [entryFile],
      outdir: "./dist",
      format: "iife",
      naming: `${theme.id}.uc.js`,
      minify: false,
      sourcemap: "none",
      external: [],
      target: "browser",
    });

    if (result.success) {
      const outputPath = result.outputs[0].path;
      const content = await Bun.file(outputPath).text();
      const banneredContent = banner + content;
      await Bun.write(outputPath, banneredContent);
      console.log(`✓ Built ${outputPath}`);
    }
  } catch (error) {
    console.error(`✗ Failed to build ${dir}:`, error);
    process.exit(1);
  }
}

// Main build function
async function build() {
  const mods = getSubdirectories(process.cwd());
  const target = process.env.TARGET;

  let modsToBuild = mods;
  if (target) {
    modsToBuild = mods.filter((dir) => {
      const themePath = path.join(dir, "theme.json");
      if (!fs.existsSync(themePath)) return false;

      const theme = JSON.parse(fs.readFileSync(themePath, "utf-8"));
      const normalizedTarget = target.replace(/-/g, "");
      const normalizedThemeId = theme.id.replace(/-/g, "");
      return normalizedThemeId.includes(normalizedTarget);
    });
  }

  // Build each mod
  for (const dir of modsToBuild) {
    const themePath = path.join(dir, "theme.json");
    const entryFile = path.join(dir, "index.js");

    if (!fs.existsSync(themePath) || !fs.existsSync(entryFile)) {
      continue;
    }

    const theme = JSON.parse(fs.readFileSync(themePath, "utf-8"));
    if (!theme.scripts) continue;

    await buildMod(dir, themePath, entryFile, theme);
  }

  console.log("Build completed!");
}

await build();
