import fs from "fs";
import path from "path";
import { spawn } from "child_process";

const getSubdirectories = (dir) => {
  return fs.readdirSync(dir).filter((file) => {
    const fullPath = path.join(dir, file);
    return (
      fs.statSync(fullPath).isDirectory() &&
      !file.startsWith(".") &&
      file !== "node_modules" &&
      file !== "dist"
    );
  });
};

const createBanner = (themePath) => {
  const theme = JSON.parse(fs.readFileSync(themePath, "utf-8"));

  let banner = `// ==UserScript==
// @name            ${theme.name}
// @description     ${theme.description}
// @author          ${theme.author}
// @version         ${theme.version}
// @lastUpdated     ${theme.updatedAt}
`;

  if (theme.ignoreCache !== false) {
    banner += `// @ignorecache\n`;
  }

  const standardKeys = [
    "id",
    "name",
    "description",
    "author",
    "version",
    "updatedAt",
    "tags",
    "fork",
    "preferences",
    "style",
    "scripts",
    "readme",
    "image",
    "createdAt",
    "ignoreCache",
  ];

  for (const key in theme) {
    if (!standardKeys.includes(key)) {
      const value = theme[key];
      if (Array.isArray(value)) {
        value.forEach((item) => {
          banner += `// @${key.padEnd(15)} ${item}\n`;
        });
      } else if (typeof value === "boolean") {
        if (value) banner += `// @${key}\n`;
      } else {
        banner += `// @${key.padEnd(15)} ${value}\n`;
      }
    }
  }

  banner += `// ==/UserScript==

// This file was automatically generated. Do not edit this file directly.
// Any changes made here will be overwritten.
// To make changes, please edit the source files in the repository:
// https://github.com/BibekBhusal0/zen-custom-js

`;

  return banner;
};

// Build function using Bun CLI
function buildMod(themePath, entryFile, theme, isWatch = false) {
  const banner = createBanner(themePath);

  const args = [
    "build",
    entryFile,
    "--outdir",
    "./dist",
    "--format",
    "iife",
    "--target",
    "browser",
    "--banner",
    banner,
  ];

  if (isWatch) args.push("--watch");
  if (theme.id === "browse-bot") {
    args.push(
      "--splitting",
      "--entry-naming",
      "browse-bot.uc.mjs",
      "--chunk-naming",
      "vercel-ai-sdk.uc.mjs"
    );
  } else args.push("--entry-naming", `${theme.id}.uc.js`);

  const child = spawn("bun", args, { stdio: "inherit" });

  return new Promise((resolve, reject) => {
    child.on("close", (code) => {
      if (code === 0) {
        resolve();
      } else {
        reject(new Error(`Build failed with code ${code}`));
      }
    });

    child.on("error", reject);
  });
}

// Main build function
async function build() {
  const mods = getSubdirectories(process.cwd());
  const target = process.env.TARGET;
  const isWatch = process.argv.includes("--watch");

  let modsToBuild = mods;
  if (target) {
    modsToBuild = mods.filter((dir) => {
      const themePath = path.join(dir, "theme.json");
      if (!fs.existsSync(themePath)) return false;

      const theme = JSON.parse(fs.readFileSync(themePath, "utf-8"));
      const normalizedTarget = target.replace(/-/g, "");
      const normalizedThemeId = theme.id.replace(/-/g, "");
      return normalizedThemeId.includes(normalizedTarget);
    });
  }

  for (const dir of modsToBuild) {
    const themePath = path.join(dir, "theme.json");
    const entryFile = path.join(dir, "index.js");

    if (!fs.existsSync(themePath) || !fs.existsSync(entryFile)) {
      continue;
    }

    const theme = JSON.parse(fs.readFileSync(themePath, "utf-8"));
    if (!theme.scripts) continue;

    await buildMod(themePath, entryFile, theme, isWatch);
  }
}

build().catch(() => {
  process.exit(1);
});
